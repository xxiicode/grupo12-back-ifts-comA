extends layout

block content
  .container.mt-4
    if error
      .alert.alert-danger #{error}
    if success
      .alert.alert-success #{success}

    .card.shadow-sm
      .card-body
        h2.text-primary.mb-3 Lista de Eventos

        if eventos && eventos.length
          table.table.table-striped.table-hover.align-middle
            thead.table-primary
              tr
                th Nombre
                th Fecha
                th Lugar
                th Presupuesto
                th Estado
                th Cliente
                th Coordinador
                th Asistentes
                th.text-center Acciones
            tbody
              each e in eventos
                tr
                  td #{e.nombre}
                  td #{e.fechaFormateada}
                  td #{e.lugar}
                  td $#{e.presupuesto}
                  td #{e.estado}
                  td #{e.cliente ? (e.cliente.nombre || e.cliente.username) : 'Sin asignar'}
                  td #{e.coordinadorId ? (e.coordinadorId.nombre || e.coordinadorId.username) : '-'}
                  td
                    if e.asistentesIds && e.asistentesIds.length
                      each a in e.asistentesIds
                        span.badge.bg-secondary.me-1 #{a.username || a.nombre}
                    else
                      | -
                  td.text-center
                    if user && ["admin","coordinador"].includes(user.rol)
                      a.btn.btn-sm.btn-outline-secondary.me-2(href=`/eventos/editar/${e.id}`)
                        i.bi.bi-pencil-fill
                        |  Editar
                    if user && user.rol === "admin"
                      button.btn.btn-sm.btn-outline-danger.me-2.delete-btn(data-id=e.id data-nombre=e.nombre)
                        i.bi.bi-trash-fill
                        |  Eliminar
                    // Chat: disponible si el usuario tiene acceso (será validado por el controlador)
                    a.btn.btn-sm.btn-outline-info(href=`/eventos/chat/${e.id}`)
                      i.bi.bi-chat-dots-fill
                      |  Chat
        else
          .alert.alert-info.mt-3 No hay eventos cargados.

    // CREAR EVENTO -> solo admin y coordinador
    if user && ["admin","coordinador"].includes(user.rol)
      if clientes && clientes.length
        .card.mt-4.shadow-sm
          .card-body
            h3.text-primary.mb-3 Agregar nuevo evento
            form(action="/eventos" method="post")
              .row.g-3
                .col-md-4
                  label.form-label(for="nombre") Nombre
                  input.form-control(type="text" name="nombre" required)
                .col-md-4
                  label.form-label(for="fecha") Fecha
                  input.form-control(type="date" name="fecha" required)
                .col-md-4
                  label.form-label(for="lugar") Lugar
                  input.form-control(type="text" name="lugar")
                .col-md-4
                  label.form-label(for="presupuesto") Presupuesto
                  input.form-control(type="number" name="presupuesto")
                .col-md-4
                  label.form-label(for="estado") Estado
                  select.form-select(name="estado")
                    option(value="Planificado") Planificado
                    option(value="En curso") En curso
                    option(value="Finalizado") Finalizado
                .col-md-4
                  label.form-label(for="clienteId") Cliente
                  select.form-select(name="clienteId" required)
                    option(value="") Seleccionar cliente
                    each c in clientes
                      option(value=c._id) #{c.nombre || c.username} (#{c.username})
                .col-md-4
                  label.form-label(for="coordinadorId") Coordinador
                  select.form-select(name="coordinadorId" required)
                    option(value="") Seleccionar coordinador
                    each coord in coordinadores
                      option(value=coord._id) #{coord.nombre || coord.username} (#{coord.username})
                .col-md-8
                  label.form-label(for="asistentesIds") Asistentes (Ctrl/Cmd + click para seleccionar varios, max 10)
                  select.form-select(name="asistentesIds" multiple required size=6)
                    each a in asistentes
                      option(value=a._id) #{a.nombre || a.username} (#{a.username})
              .mt-3
                button.btn.btn-primary(type="submit") Agregar
    else
      .alert.alert-secondary.mt-4.text-center
        i.bi.bi-lock-fill.me-2
        | No tienes permisos para agregar eventos.

  script.
    document.addEventListener('click', async (ev) => {
      if (ev.target.closest('.delete-btn')) {
        const btn = ev.target.closest('.delete-btn');
        const id = btn.dataset.id;
        const nombre = btn.dataset.nombre;
        if (!confirm('¿Eliminar evento: ' + nombre + '?')) return;
        const res = await fetch('/eventos/api/' + id, { method: 'DELETE' });
        if (res.ok) location.reload();
        else alert('Error al eliminar');
      }
    });
